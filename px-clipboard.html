<!--
    Relative paths assume component is being run from inside an app or another component, where dependencies are flat
    siblings. When this component is run from its own repo (e.g. tests, examples), we assume the server is started with
    'grunt depserve' (or similar server setup) to enable correct finding of bower dependencies for local runs.
-->
<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../polymer-font-awesome/polymer-font-awesome.html" />
<link rel="import" href="clipboard.js.html"></script> <!-- this is an html page that imports the clipboard.js library in a way that allows reuse of the library. -->

<!--
Element allowing copy/cut to clipboard.
The value to be copied/cut must be placed in an input/textarea INSIDE px-clipboard, or else the
dataClipboardText property must be used.

##### Usage

    <px-clipboard copy-from="#copyMe"><input type="text" value="copy me" id="copyMe"/></px-clipboard>

Or, to cut:

    <px-clipboard data-clipboard-action="cut" copy-from="#cutMe"><input type="text" value="Cut me" id="cutMe"/></px-clipboard>

Or, with no input/textarea:

    <px-clipboard data-clipboard-text="This text will be copied."></px-clipboard>

@element px-clipboard
@blurb Element allowing copy to clipboard.
@homepage index.html
@demo demo.html
-->
<dom-module id="px-clipboard">
  <link rel="import" type="css" href="css/px-clipboard.css"/>
  <template>
    <content></content>
    <iron-icon icon="polymer-font-awesome:fa-clipboard" id="copy"></iron-icon>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-clipboard',

    /**
     * Properties block, expose attribute values to the DOM via 'notify'
     *
     * @property properties
     * @type Object
     */
    properties: {
      /**
       * An attribute that allows you to cut text (vs copy).
       * Available options are 'cut' or 'copy'
       * @property dataClipboardAction
       * @type String
       */
      dataClipboardAction: {
        type: String,
        value: ''
      },
      /**
       * An attribute that points to the element holding the value
       * you'd like to cut or copy.
       * Possible options are `tag`, `class` or `ID`.
       * @property copyFrom
       * @type String
       */
      copyFrom: {
        type: String,
        value: ''
      },
      /**
       *
       * An object that holds a reference to the node from which the value is copied/cut from.
       *
       * @property _copyFromElem
       * @type Objecct
       */
      _copyFromElem: {
        type: Object,
        observer: '_initializeClipboard'
      },
      /**
       * An attribute that allows you to set the text that will go into the clipboard.
       *
       * @property dataClipboardText
       * @type String
       */
      dataClipboardText: {
        type: String,
        value: ''
      },
    },
    attached: function() {
      var content = this.$$('content'),
          _observer = Polymer.dom(content).observeNodes(this._setCopyFrom.bind(this)),
          self = this,
          copy = this.$$('#copy');
      //check whether this is a text only clipboard element.
      if (this.dataClipboardText) {
        //initialize clipboard`
        var clipboard = this._initializeTextOnly(self, copy);
        //and initialze the events
        this._setEventFire(clipboard, self);
      }
    },
    detached: function() {
      clipboard.destroy();
    },
    /**
     * This method is called when the _copyFromElem property changes (the light dom is loaded).
     * It initilizes a clipboard object.
     *
     * @method _initializeClipboard
     *
     */
    _initializeClipboard: function() {
      var self = this,
          copy = this.$$('#copy'),
          clipboard;

      clipboard = this._initializeCopy(self, copy);

      if (this.dataClipboardAction) {
        clipboard.action = function(trigger) {
          return self.dataClipboardAction;
        };
      }

      this._setEventFire(clipboard, self);

    },
    /**
     * This method captures the internal success/error message sent by the clipboard
     * and calls _success or _error.
     *
     * @method _initializeClipboard
     *
     */
    _setEventFire: function(clipboard, self) {

      clipboard.on('success', function(e) {
        self._success(e);
      })
      .on('error', function(e) {
        self._error(e);
      });
    },
    /**
     * This method finds the element specified in copyFrom, and sets _copyFromElem
     *
     *
     * @method _setCopyFrom
     *
     */
    _setCopyFrom: function() {
      var copyFrom  = Polymer.dom(this).querySelector(this.copyFrom);

      this.set('_copyFromElem', copyFrom);
    },
    /**
     * This method returns a new instance of the Clipboard object
     * and sets the _copyFrom property
     *
     * @method _initializeCopy
     * @return {Clipboard Object}
     *
     */
    _initializeCopy: function(self, copy) {

      var content = this.$$('content'),
          copyFrom;

      if (this.copyFrom) {

        this._setCopyFrom();

        return new Clipboard(copy,
          { target:
              function(trigger) {
                return self._copyFromElem;
            }
          }
        );
      } else {
        throw "You must specify where you'd like the value copied/cut from using the copy-from attribute";
      }

    },
    /**
     * This method returns a new instance of the Clipboard object
     * that has text set on it using the data-clipboard-text attribute
     *
     * @method _initializeTextOnly
     * @return {Clipboard Object}
     *
     */
    _initializeTextOnly: function(self, copy) {

      return new Clipboard(copy,
        { text:
            function(trigger) {
              return self.dataClipboardText;
          }
        }
      );
    },
    /*
    * This event is fired after a successful copy/cut.
    *  @event clipboardSuccess
    */
    /*
    * This method fires off a clipboardSuccess event
    *  @method _success
    */
    _success: function(e) {
      this.fire('clipboardSuccess', e);
    },
    /*
    * This event is fired after an error occurs with copy/cut.
    *  @event clipboardError
    */
    /*
    * This method fires off a clipboardError event
    *  @method _error
    */
    _error: function(e) {
      this.fire('clipboardError', e);
    }
  });
</script>
